<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Coze API æµ‹è¯•</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      button {
        background: #8b5cf6;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #7c3aed;
      }
      .result {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        white-space: pre-wrap;
        font-family: monospace;
        max-height: 300px;
        overflow-y: auto;
      }
      .error {
        background: #fee;
        border: 1px solid #fcc;
      }
      .success {
        background: #efe;
        border: 1px solid #cfc;
      }
      input[type="text"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin: 5px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ”® Coze API è°ƒè¯•å·¥å…·</h1>

      <div class="test-section">
        <h3>API é…ç½®ä¿¡æ¯</h3>
        <div id="config-info"></div>
      </div>

      <div class="test-section">
        <h3>æµ‹è¯•æ¶ˆæ¯å‘é€</h3>
        <input
          type="text"
          id="test-message"
          placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯"
          value="ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ç™½æ°´æ™¶çš„åŠŸæ•ˆ"
        />
        <button onclick="testAPI()">å‘é€æµ‹è¯•æ¶ˆæ¯</button>
        <button onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
        <div id="api-result" class="result"></div>
      </div>

      <div class="test-section">
        <h3>åŸå§‹å“åº”æ•°æ®</h3>
        <div id="raw-response" class="result"></div>
      </div>

      <div class="test-section">
        <h3>è§£æåçš„æ¶ˆæ¯</h3>
        <div id="parsed-message" class="result"></div>
      </div>
    </div>

    <script>
      // Coze API é…ç½®
      const COZE_CONFIG = {
        botId: "7541398190961705023",
        token:
          "pat_2epjuhkDAZi6CXmOPziMsMC9EYUWrbJhhqzH82AGN9pZFMwMaAnMvFyKFRhSZHJ8",
        apiUrl: "https://api.coze.cn/open_api/v2/chat",
        conversationId: null,
      };

      // æ˜¾ç¤ºé…ç½®ä¿¡æ¯
      function showConfig() {
        const configDiv = document.getElementById("config-info");
        configDiv.innerHTML = `
                <strong>Bot ID:</strong> ${COZE_CONFIG.botId}<br>
                <strong>Token:</strong> ${COZE_CONFIG.token.substring(
                  0,
                  10
                )}...<br>
                <strong>API URL:</strong> ${COZE_CONFIG.apiUrl}<br>
                <strong>Conversation ID:</strong> ${
                  COZE_CONFIG.conversationId || "æœªè®¾ç½®"
                }
            `;
      }

      // æµ‹è¯• API è°ƒç”¨
      async function testAPI() {
        const message = document.getElementById("test-message").value.trim();
        if (!message) {
          alert("è¯·è¾“å…¥æµ‹è¯•æ¶ˆæ¯");
          return;
        }

        const resultDiv = document.getElementById("api-result");
        const rawDiv = document.getElementById("raw-response");
        const parsedDiv = document.getElementById("parsed-message");

        resultDiv.innerHTML = "æ­£åœ¨å‘é€è¯·æ±‚...";
        resultDiv.className = "result";

        try {
          const requestBody = {
            bot_id: COZE_CONFIG.botId,
            user: "user",
            query: message,
            chat_history: [],
            stream: false,
            ...(COZE_CONFIG.conversationId && {
              conversation_id: COZE_CONFIG.conversationId,
            }),
          };

          console.log("å‘é€è¯·æ±‚:", requestBody);

          const response = await fetch(COZE_CONFIG.apiUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${COZE_CONFIG.token}`,
            },
            body: JSON.stringify(requestBody),
          });

          console.log("å“åº”çŠ¶æ€:", response.status, response.statusText);

          if (!response.ok) {
            throw new Error(
              `API è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`
            );
          }

          const data = await response.json();
          console.log("å“åº”æ•°æ®:", data);

          // æ˜¾ç¤ºåŸå§‹å“åº”
          rawDiv.innerHTML = JSON.stringify(data, null, 2);
          rawDiv.className = "result success";

          // æ›´æ–°ä¼šè¯ID
          if (data.conversation_id) {
            COZE_CONFIG.conversationId = data.conversation_id;
            showConfig();
          }

          // è§£ææ¶ˆæ¯
          let parsedMessage = "";
          if (data.messages && data.messages.length > 0) {
            const lastMessage = data.messages[data.messages.length - 1];
            parsedMessage = lastMessage.content || "æœªæ‰¾åˆ°æ¶ˆæ¯å†…å®¹";
            parsedDiv.innerHTML = `ä» messages æ•°ç»„è§£æ: ${parsedMessage}`;
          } else if (data.answer) {
            parsedMessage = data.answer;
            parsedDiv.innerHTML = `ä» answer å­—æ®µè§£æ: ${parsedMessage}`;
          } else {
            parsedMessage = "æœªæ‰¾åˆ°å¯è§£æçš„æ¶ˆæ¯å†…å®¹";
            parsedDiv.innerHTML = parsedMessage;
          }

          resultDiv.innerHTML = `âœ… API è°ƒç”¨æˆåŠŸ\nè§£æçš„æ¶ˆæ¯: ${parsedMessage}`;
          resultDiv.className = "result success";
        } catch (error) {
          console.error("API è°ƒç”¨å¤±è´¥:", error);
          resultDiv.innerHTML = `âŒ API è°ƒç”¨å¤±è´¥:\n${error.message}`;
          resultDiv.className = "result error";
          rawDiv.innerHTML = "è¯·æ±‚å¤±è´¥ï¼Œæ— å“åº”æ•°æ®";
          parsedDiv.innerHTML = "è¯·æ±‚å¤±è´¥ï¼Œæ— æ³•è§£ææ¶ˆæ¯";
        }
      }

      // æ¸…ç©ºç»“æœ
      function clearResults() {
        document.getElementById("api-result").innerHTML = "";
        document.getElementById("raw-response").innerHTML = "";
        document.getElementById("parsed-message").innerHTML = "";
      }

      // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºé…ç½®
      document.addEventListener("DOMContentLoaded", function () {
        showConfig();
      });

      // å›è½¦é”®å‘é€æ¶ˆæ¯
      document
        .getElementById("test-message")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            testAPI();
          }
        });
    </script>
  </body>
</html>
